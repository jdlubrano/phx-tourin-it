#!/usr/bin/python3

import pdb
import re
import subprocess
import sys

bump_type = sys.argv[1] if len(sys.argv) > 1 else None

if bump_type not in ["major", "minor", "patch"]:
  exit(f'Provide an argument of "major", "minor", or "patch". Ex: {sys.argv[0]} patch')

with open("mix.exs", mode="r+") as f:
  print("Updating mix.exs...")
  contents = f.read()
  version_match = re.search(r'version: "(?P<major>\d+)\.(?P<minor>\d+)\.(?P<patch>\d+)"', contents)
  version = version_match.groupdict()
  version[bump_type] = int(version[bump_type]) + 1

  if bump_type == "major":
    version["minor"] = 0
    version["patch"] = 0
  elif bump_type == "minor":
    version["patch"] = 0

  version_string = f"{version['major']}.{version['minor']}.{version['patch']}"
  updated_contents = contents.replace(version_match.group(), f'version: "{version_string}"')
  f.seek(0, 0)
  f.write(updated_contents)

git_tag = f"v{version_string}"
print(f"Creating git tag {git_tag}")
subprocess.run(f'git commit -am "Bump version to {git_tag}"', shell=True, check=True)
subprocess.run(f'git tag -a "{git_tag}" -m "{git_tag}"', shell=True, check=True)
